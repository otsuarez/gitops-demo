# gitops-demo
Using argocd for gitops



# tl;dr
```sh
kind create cluster --name demo01
alias k='kubectl --context kind-demo01'

kustomize build argocd/setup | k apply -n argocd -f  -

stern ".*" --all-namespaces --tail 0

# cleanup
kustomize build argocd/setup | k delete -f  -
kind delete cluster --name demo01
```

error
```
argocd argocd-repo-server-69898c566b-k72xb argocd-repo-server time="2020-01-07T00:04:18Z" level=info msg="kustomize build /tmp/https:__github.com_otsuarez_gitops-demo/addons/local" dir= execID=T95Iz
argocd argocd-repo-server-69898c566b-k72xb argocd-repo-server time="2020-01-07T00:04:18Z" level=error msg="`kustomize build /tmp/https:__github.com_otsuarez_gitops-demo/addons/local` failed exit status 1: Error: var '{APP_DOMAIN ~G_v1_ConfigMap {data.domain}}' cannot be mapped to a field in the set of known resources" execID=T95Iz
argocd argocd-repo-server-69898c566b-k72xb argocd-repo-server time="2020-01-07T00:04:18Z" level=error msg="finished unary call with code Unknown" error="`kustomize build /tmp/https:__github.com_otsuarez_gitops-demo/addons/local` failed exit status 1: Error: var '{APP_DOMAIN ~G_v1_ConfigMap {data.domain}}' cannot be mapped to a field in the set of known resources" grpc.code=Unknown grpc.method=GenerateManifest grpc.request.deadline="2020-01-07T00:05:17Z" grpc.service=repository.RepoServerService grpc.start_time="2020-01-07T00:04:17Z" grpc.time_ms=624.536 span.kind=server system=grpc
argocd argocd-application-controller-64889d9f8-42w58 argocd-application-controller time="2020-01-07T00:04:18Z" level=info msg="Normalized app spec: {\"status\":{\"conditions\":[{\"message\":\"rpc error: code = Unknown desc = `kustomize build /tmp/https:__github.com_otsuarez_gitops-demo/addons/local` failed exit status 1: Error: var '{APP_DOMAIN ~G_v1_ConfigMap {data.domain}}' cannot be mapped to a field in the set of known resources\",\"type\":\"ComparisonError\"}]}}" application=addons
```


# installation

## Client side

https://github.com/bitnami-labs/sealed-secrets/releases

Linux x86_64
 
```sh
wget https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.9.6/kubeseal-linux-amd64 -O kubeseal
sudo install -m 755 kubeseal /usr/local/bin/kubeseal
```

MacOS
```sh
brew install kubeseal
```

## Cluster side

Install SealedSecret CRD, server-side controller into kube-system namespace.

```sh
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.9.6/controller.yaml
```

to begin with ...

> sealedsecrets.bitnami.com/cluster-wide: "true"


---

```sh
kind create cluster --name demo01
alias k='kubectl --context kind-demo01'


kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.9.6/controller.yaml
```


---
https://andrewaadland.me/2019-11-09-quickstart-bitnami-sealed-secrets/

```sh
# 1. Create the sealed-secrets namespace (and label it) -- or not ...(check error below)
# k create namespace sealed-secrets && \
# k label namespace sealed-secrets name=sealed-secrets

# 2. Run the install command
k -n kube-system apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.9.6/controller.yaml

# 3. Download the public key that was generated by the controller:
# kubeseal --fetch-cert --controller-name=sealed-secrets --controller-namespace=sealed-secrets > ~/kubeseal.pem
kubeseal --fetch-cert --controller-name=sealed-secrets-controller --controller-namespace=kube-system > kubeseal.pem

# 4. Create an alias to automatically pass this certificate to the kubeseal command:
alias kubeseal='kubeseal --cert kubeseal.pem'
```

error:
```sh
$ k --namespace=sealed-secrets apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.9.6/controller.yaml
clusterrolebinding.rbac.authorization.k8s.io/sealed-secrets-controller unchanged
clusterrole.rbac.authorization.k8s.io/secrets-unsealer unchanged
customresourcedefinition.apiextensions.k8s.io/sealedsecrets.bitnami.com unchanged
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
the namespace from the provided object "kube-system" does not match the namespace "sealed-secrets". You must pass '--namespace=kube-system' to perform this operation.
```


---


https://andrewaadland.me/2019-11-09-quickstart-bitnami-sealed-secrets/#creating-encrypted-secrets

```sh
mkdir -p secrets
cat <<'_EOF_' >secrets/kustomization.yaml
resources:
- auth-nginx.json
_EOF_

export SEALED_SECRETS_NAME='auth-nginx' \
 SEALED_SECRETS_NAMESPACE='default' \
 SEALED_SECRETS_USERNAME='nginx-auth' \
 SEALED_SECRETS_PASSWORD='nginx-password'
kubectl create secret generic "$SEALED_SECRETS_NAME" --dry-run -o yaml --from-literal auth=$(htpasswd -nb "$SEALED_SECRETS_USERNAME" "$SEALED_SECRETS_PASSWORD") > secrets/unencrypted-secret.yaml
kubeseal <secrets/unencrypted-secret.yaml >secrets/$SEALED_SECRETS_NAME.json

rm secrets/unencrypted-secret.yaml
kubectl kustomize secrets/
kubectl apply -k secrets/
unset SEALED_SECRETS_NAME SEALED_SECRETS_NAMESPACE SEALED_SECRETS_USERNAME SEALED_SECRETS_PASSWORD
```

```sh
$ k get secret/auth-nginx -o yaml
apiVersion: v1
data:
  auth: bmdpbngtYXV0aDokYXByMSRpLy9TWGdrQSQwTUV3QmhzcVN1QU80VERrNzJ4aDQu
kind: Secret
metadata:
  creationTimestamp: "2020-01-08T19:08:32Z"
  name: auth-nginx
  namespace: default
  ownerReferences:
  - apiVersion: bitnami.com/v1alpha1
    controller: true
    kind: SealedSecret
    name: auth-nginx
    uid: d1acaa57-3fed-4dcb-8074-d919e61c3366
  resourceVersion: "1349"
  selfLink: /api/v1/namespaces/default/secrets/auth-nginx
  uid: d0b2f970-a2c6-4654-bc68-3d161cbb6c90
type: Opaque
$ k get secret/auth-nginx -o 'go-template={{index .data "auth"}}'  | base64 --decode
nginx-auth:$apr1$i//SXgkA$0MEwBhsqSuAO4TDk72xh4.
```


---


https://andrewaadland.me/2019-11-09-quickstart-bitnami-sealed-secrets/#creating-a-secret-containing-keyvalue-pairs

```sh

mkdir -p secrets
cat <<'_EOF_' >secrets/kustomization.yaml
resources:
- auth-app-password.json
_EOF_

export SEALED_SECRETS_NAME='auth-app-password' \
 SEALED_SECRETS_NAMESPACE='default' \
 SEALED_SECRETS_KEY='app-username' \
 SEALED_SECRETS_PASSWORD='app-password'
#

kubectl create secret generic "$SEALED_SECRETS_NAME" --dry-run -o yaml --from-literal $SEALED_SECRETS_KEY="$SEALED_SECRETS_PASSWORD" > secrets/unencrypted-secret.yaml
kubeseal <secrets/unencrypted-secret.yaml >secrets/$SEALED_SECRETS_NAME.json
rm secrets/unencrypted-secret.yaml
kubectl kustomize secrets/
kubectl apply -k secrets/
unset SEALED_SECRETS_NAME SEALED_SECRETS_NAMESPACE SEALED_SECRETS_KEY SEALED_SECRETS_PASSWORD
```

```sh
$ k get secret/auth-app-password -o yaml
apiVersion: v1
data:
  app-username: YXBwLXBhc3N3b3Jk
kind: Secret
metadata:
  creationTimestamp: "2020-01-08T19:43:14Z"
  name: auth-app-password
  namespace: default
  ownerReferences:
  - apiVersion: bitnami.com/v1alpha1
    controller: true
    kind: SealedSecret
    name: auth-app-password
    uid: 7b529390-94f1-453d-aebe-2bbdaee1440b
  resourceVersion: "3884"
  selfLink: /api/v1/namespaces/default/secrets/auth-app-password
  uid: d925330f-37db-4542-9b40-fc1c5f0a125c
type: Opaque
$ k get secret/auth-app-password -o 'go-template={{index .data "app-username"}}'  | base64 --decode
app-password
```

---


# [Backup / Restore](https://andrewaadland.me/2019-11-09-quickstart-bitnami-sealed-secrets/#backup--restore)

Backing Up Your Keys

To create a kubernetes secret that contains the public and private key for the sealed-secrets certificate authority, run this command:

```sh
echo "sealed-secrets.keys" >> .gitignore
# if needed, update the name of secret here
k get -n kube-system secret sealed-secrets-keyzj6x7 -o yaml > sealed-secrets.keys
cat sealed-secrets.keys
```

---

# [Restoring Your Keys](https://andrewaadland.me/2019-11-09-quickstart-bitnami-sealed-secrets/#restoring-your-keys)



```sh
kind delete cluster --name demo01

kind create cluster --name demo01
# alias k='kubectl --context kind-demo01'



# apply the secret
k create -f sealed-secrets.keys
# Install the controller 
kubectl apply -f https://github.com/bitnami-labs/sealed-secrets/releases/download/v0.9.6/controller.yaml
# Check the containerâ€™s logs to confirm that it loaded the same master secret
kubectl -n kube-system logs $(k get pods -A | grep sealed-secrets | awk '{print $2}')
# Apply your various encrypted secrets
k apply -k secrets

# quick test
k get secret/auth-app-password -o 'go-template={{index .data "app-username"}}'  | base64 --decode
```


```sh
$ kubectl -n kube-system logs $(k get pods -A | grep sealed-secrets | awk '{print $2}')
2020/01/08 20:21:48 Starting sealed-secrets controller version: v0.9.6+dirty
2020/01/08 20:21:48 Searching for existing private keys
2020/01/08 20:21:48 ----- sealed-secrets-keyzj6x7
2020/01/08 20:21:48 HTTP server serving on :8080
$ k get secret/auth-app-password -o 'go-template={{index .data "app-username"}}'  | base64 --decode
app-password
```


